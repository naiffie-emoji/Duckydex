<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Combat - Duckydex</title>
  <link rel="icon" type="image/png" href="filet-canard.png">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f0f8ff;
      color: #333;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100vh;
      padding: 1rem;
    }

    #player1, #player2 {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      max-width: 600px;
      margin: 0 auto;
      user-select: none;
    }

    #player1 {
      justify-content: flex-start;
      margin-bottom: auto;
    }

    #player2 {
      justify-content: flex-start;
      margin-top: auto;
      flex-direction: row-reverse;
    }

    #player1 img, #player2 img {
      width: 120px;
      height: 120px;
      object-fit: contain;
      border-radius: 12px;
      background: #e6f7ff;
    }

    .info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .name {
      font-weight: bold;
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
    }

    .hp-bar {
      position: relative;
      background: #ddd;
      border-radius: 10px;
      height: 20px;
      width: 100%;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .hp-bar-inner {
      background: #38d9a9;
      height: 100%;
      width: 100%;
      transition: width 0.3s ease;
    }

    .hp-text {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 0;
      left: 0;
      line-height: 20px;
      font-weight: bold;
      color: #333;
      user-select: none;
    }

    .attack-container {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
      gap: 2rem;
    }

    button.attack-btn {
      background: #38d9a9;
      border: none;
      color: white;
      padding: 1rem 2rem;
      font-size: 1.2rem;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }

    button.attack-btn:disabled {
      background: #a0d8cc;
      cursor: not-allowed;
    }

    #message {
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      margin: 1rem 0;
      min-height: 1.5em;
      user-select: none;
    }

    /* Zone centrale pour tapotage */
    #tap-area {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 250px;
      background: #38d9a9;
      border-radius: 30px;
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.8rem;
      font-weight: bold;
      user-select: none;
      cursor: pointer;
      box-shadow: 0 0 15px #38d9a9aa;
      text-align: center;
      padding: 1rem;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="player1" aria-label="Joueur 1">
    <img src="" alt="Monture joueur 1" id="p1-img" />
    <div class="info">
      <div class="name" id="p1-name"></div>
      <div class="hp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
        <div class="hp-bar-inner" id="p1-hp-bar" style="width: 100%;"></div>
        <div class="hp-text" id="p1-hp-text">100 / 100</div>
      </div>
    </div>
    <button class="attack-btn" id="p1-attack-btn" disabled>Attaquer</button>
  </div>

  <div id="message" role="alert" aria-live="polite"></div>

  <div id="player2" aria-label="Joueur 2">
    <button class="attack-btn" id="p2-attack-btn" disabled>Attaquer</button>
    <div class="info">
      <div class="name" id="p2-name"></div>
      <div class="hp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
        <div class="hp-bar-inner" id="p2-hp-bar" style="width: 100%;"></div>
        <div class="hp-text" id="p2-hp-text">100 / 100</div>
      </div>
    </div>
    <img src="" alt="Monture joueur 2" id="p2-img" />
  </div>

  <div id="tap-area" aria-label="Zone de tapotage" role="button" tabindex="0">
    <!-- Texte dynamique ici -->
  </div>

  <script>
    // Récupérer les équipes dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const ids1 = (urlParams.get("ids1") || "").split(",").filter(id => id.trim());
    const ids2 = (urlParams.get("ids2") || "").split(",").filter(id => id.trim());

    // Données canards (on doit charger canards.json)
    let duckData = [];

    // Montures des joueurs (objets)
    let team1 = [];
    let team2 = [];

    // Index monture en cours pour chaque joueur
    let currentIndex1 = 0;
    let currentIndex2 = 0;

    // PV max et actu (varie selon rareté)
    let maxHp1 = 10;
    let maxHp2 = 10;
    let hp1 = maxHp1;
    let hp2 = maxHp2;

    // Tap counts durant attaque
    let tapCount = 0;

    // Qui attaque : '1' ou '2'
    let currentTurn = null;

    // Timer attaque et compte à rebours
    let attackTimer = null;
    let countdownTimer = null;

    // Éléments DOM
    const p1Img = document.getElementById("p1-img");
    const p1Name = document.getElementById("p1-name");
    const p1HpBar = document.getElementById("p1-hp-bar");
    const p1HpText = document.getElementById("p1-hp-text");
    const p1AttackBtn = document.getElementById("p1-attack-btn");

    const p2Img = document.getElementById("p2-img");
    const p2Name = document.getElementById("p2-name");
    const p2HpBar = document.getElementById("p2-hp-bar");
    const p2HpText = document.getElementById("p2-hp-text");
    const p2AttackBtn = document.getElementById("p2-attack-btn");

    const messageDiv = document.getElementById("message");
    const tapArea = document.getElementById("tap-area");

    // Fonction pour récupérer PV max selon rareté
    function getMaxHp(rarity) {
      switch(rarity) {
        case "Commun": return 10;
        case "Rare": return 20;
        case "Épique": return 30;
        case "Légendaire": return 40;
        default: return 10;
      }
    }

    // Charger canards.json puis initialiser combat
    fetch("canards.json").then(res => res.json()).then(data => {
      duckData = data;

      team1 = ids1.map(id => duckData.find(d => d.id === id)).filter(Boolean);
      team2 = ids2.map(id => duckData.find(d => d.id === id)).filter(Boolean);

      if(team1.length === 0 || team2.length === 0) {
        alert("Erreur : équipe invalide.");
        window.location.href = "index.html";
        return;
      }

      currentIndex1 = 0;
      currentIndex2 = 0;

      maxHp1 = getMaxHp(team1[currentIndex1].rarity);
      maxHp2 = getMaxHp(team2[currentIndex2].rarity);

      hp1 = maxHp1;
      hp2 = maxHp2;

      updateUI();
      startTurnRandom();
    }).catch(() => {
      alert("Erreur chargement données.");
      window.location.href = "index.html";
    });

    // Met à jour l'affichage montures, PV, boutons
    function updateUI() {
      const m1 = team1[currentIndex1];
      const m2 = team2[currentIndex2];

      // Joueur 1
      p1Img.src = m1.image;
      p1Img.alt = m1.name;
      p1Name.textContent = m1.name;
      updateHpBar(p1HpBar, p1HpText, hp1, maxHp1);

      // Joueur 2
      p2Img.src = m2.image;
      p2Img.alt = m2.name;
      p2Name.textContent = m2.name;
      updateHpBar(p2HpBar, p2HpText, hp2, maxHp2);

      // Boutons activés seulement au tour
      p1AttackBtn.disabled = currentTurn !== 1;
      p2AttackBtn.disabled = currentTurn !== 2;
    }

    // Met à jour barre HP et texte
    function updateHpBar(barElem, textElem, currentHp, maxHp) {
      const ratio = Math.max(0, currentHp) / maxHp;
      barElem.style.width = (ratio * 100) + "%";
      textElem.textContent = `${Math.max(0, currentHp)} / ${maxHp}`;
      barElem.parentElement.setAttribute("aria-valuenow", Math.max(0, currentHp));
    }

    // Commence un tour aléatoire (1 ou 2)
    function startTurnRandom() {
      currentTurn = Math.random() < 0.5 ? 1 : 2;
      messageDiv.textContent = `C'est au joueur ${currentTurn} de commencer !`;

      // Attendre 2 sec puis démarrer attaque
      setTimeout(() => {
        startCountdown();
      }, 2000);
    }

    // Compte à rebours 3, 2, 1, Go !
    function startCountdown() {
      let count = 3;
      messageDiv.textContent = `Préparez-vous... ${count}`;

      countdownTimer = setInterval(() => {
        count--;
        if(count > 0) {
          messageDiv.textContent = `Préparez-vous... ${count}`;
        } else {
          clearInterval(countdownTimer);
          messageDiv.textContent = "GO ! Tapez au centre !";
          showTapArea();
          startAttack();
        }
      }, 1000);
    }

    // Affiche la zone de tapotage
    function showTapArea() {
      tapArea.style.display = "flex";
      tapArea.textContent = "Tapez ici rapidement !";
      tapCount = 0;
      tapArea.focus();
    }

    // Cache la zone de tapotage
    function hideTapArea() {
      tapArea.style.display = "none";
      tapCount = 0;
    }

    // Démarre l'attaque avec limite de temps 5 sec
    function startAttack() {
      // Empêche clic sur boutons pendant attaque
      p1AttackBtn.disabled = true;
      p2AttackBtn.disabled = true;

      tapCount = 0;

      // Écouteur tap sur zone centrale
      tapArea.addEventListener("click", tapHandler);
      tapArea.addEventListener("keydown", keyHandler);

      // Après 5 sec, fin attaque
      attackTimer = setTimeout(() => {
        endAttack();
      }, 5000);
    }

    // Gestion tap clic
    function tapHandler() {
      tapCount++;
      tapArea.textContent = `Taps : ${tapCount}`;
    }

    // Gestion tap clavier (Enter / Space)
    function keyHandler(e) {
      if(e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        tapHandler();
      }
    }

    // Fin de l'attaque
    function endAttack() {
      tapArea.removeEventListener("click", tapHandler);
      tapArea.removeEventListener("keydown", keyHandler);
      hideTapArea();

      // Calcul des dégâts (tapCount * 1)
      const damage = tapCount;

      if(currentTurn === 1) {
        hp2 -= damage;
        if(hp2 <= 0) {
          hp2 = 0;
          updateHpBar(p2HpBar, p2HpText, hp2, maxHp2);
          messageDiv.textContent = `Joueur 1 a gagné !`;
          disableAll();
          return;
        }
      } else {
        hp1 -= damage;
        if(hp1 <= 0) {
          hp1 = 0;
          updateHpBar(p1HpBar, p1HpText, hp1, maxHp1);
          messageDiv.textContent = `Joueur 2 a gagné !`;
          disableAll();
          return;
        }
      }

      updateUI();

      // Changer de tour
      currentTurn = currentTurn === 1 ? 2 : 1;
      messageDiv.textContent = `Au joueur ${currentTurn} de jouer. Préparez-vous...`;

      // Lancer nouveau compte à rebours pour le tour suivant
      setTimeout(() => {
        startCountdown();
      }, 2000);
    }

    // Désactive boutons
    function disableAll() {
      p1AttackBtn.disabled = true;
      p2AttackBtn.disabled = true;
      hideTapArea();
    }

    // Initialement, les boutons d'attaque ne font rien (on fait tout via tap area)
    p1AttackBtn.addEventListener("click", e => e.preventDefault());
    p2AttackBtn.addEventListener("click", e => e.preventDefault());

    // Ajout accessibilité: activer tap-area avec clavier
    tapArea.addEventListener("keydown", keyHandler);
  </script>
</body>
</html>
