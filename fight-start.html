<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Combat - Duckydex</title>
  <link rel="icon" type="image/png" href="filet-canard.png">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f0f8ff;
      color: #333;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100vh;
      padding: 1rem;
    }

    #player1, #player2 {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    #player1 {
      justify-content: flex-start;
      margin-bottom: auto;
    }

    #player2 {
      justify-content: flex-start;
      margin-top: auto;
      flex-direction: row-reverse;
    }

    #player1 img, #player2 img {
      width: 120px;
      height: 120px;
      object-fit: contain;
      border-radius: 12px;
      background: #e6f7ff;
    }

    .info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .name {
      font-weight: bold;
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
    }

    .hp-bar {
      position: relative;
      background: #ddd;
      border-radius: 10px;
      height: 20px;
      width: 100%;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .hp-bar-inner {
      background: #38d9a9;
      height: 100%;
      width: 100%;
      transition: width 0.3s ease;
    }

    .hp-text {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 0;
      left: 0;
      line-height: 20px;
      font-weight: bold;
      color: #333;
      user-select: none;
    }

    .attack-container {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
      gap: 2rem;
    }

    button.attack-btn {
      background: #38d9a9;
      border: none;
      color: white;
      padding: 1rem 2rem;
      font-size: 1.2rem;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }

    button.attack-btn:disabled {
      background: #a0d8cc;
      cursor: not-allowed;
    }

    #message {
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      margin: 1rem 0;
      min-height: 1.5em;
    }
  </style>
</head>
<body>
  <div id="player1" aria-label="Joueur 1">
    <img src="" alt="Monture joueur 1" id="p1-img" />
    <div class="info">
      <div class="name" id="p1-name"></div>
      <div class="hp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
        <div class="hp-bar-inner" id="p1-hp-bar" style="width: 100%;"></div>
        <div class="hp-text" id="p1-hp-text">100 / 100</div>
      </div>
    </div>
    <button class="attack-btn" id="p1-attack-btn" disabled>Attaquer</button>
  </div>

  <div id="message" role="alert" aria-live="polite"></div>

  <div id="player2" aria-label="Joueur 2">
    <button class="attack-btn" id="p2-attack-btn" disabled>Attaquer</button>
    <div class="info">
      <div class="name" id="p2-name"></div>
      <div class="hp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
        <div class="hp-bar-inner" id="p2-hp-bar" style="width: 100%;"></div>
        <div class="hp-text" id="p2-hp-text">100 / 100</div>
      </div>
    </div>
    <img src="" alt="Monture joueur 2" id="p2-img" />
  </div>

  <script>
    // Récupérer les équipes dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const ids1 = (urlParams.get("ids1") || "").split(",").filter(id => id.trim());
    const ids2 = (urlParams.get("ids2") || "").split(",").filter(id => id.trim());

    // Données canards (on doit charger canards.json)
    let duckData = [];

    // Montures des joueurs (objets)
    let team1 = [];
    let team2 = [];

    // Index monture en cours pour chaque joueur
    let currentIndex1 = 0;
    let currentIndex2 = 0;

    // PV max / actu
    const MAX_HP = 100;
    let hp1 = MAX_HP;
    let hp2 = MAX_HP;

    // Tap counts durant attaque
    let tapCount = 0;

    // Qui attaque : '1' ou '2'
    let currentTurn = null;

    // Timer attaque
    let attackTimer = null;

    // Éléments DOM
    const p1Img = document.getElementById("p1-img");
    const p1Name = document.getElementById("p1-name");
    const p1HpBar = document.getElementById("p1-hp-bar");
    const p1HpText = document.getElementById("p1-hp-text");
    const p1AttackBtn = document.getElementById("p1-attack-btn");

    const p2Img = document.getElementById("p2-img");
    const p2Name = document.getElementById("p2-name");
    const p2HpBar = document.getElementById("p2-hp-bar");
    const p2HpText = document.getElementById("p2-hp-text");
    const p2AttackBtn = document.getElementById("p2-attack-btn");

    const messageDiv = document.getElementById("message");

    // Charger canards.json puis initialiser combat
    fetch("canards.json").then(res => res.json()).then(data => {
      duckData = data;

      team1 = ids1.map(id => duckData.find(d => d.id === id)).filter(Boolean);
      team2 = ids2.map(id => duckData.find(d => d.id === id)).filter(Boolean);

      if(team1.length === 0 || team2.length === 0) {
        alert("Erreur : équipe invalide.");
        window.location.href = "index.html";
        return;
      }

      // Init montures et PV
      currentIndex1 = 0;
      currentIndex2 = 0;
      hp1 = MAX_HP;
      hp2 = MAX_HP;

      updateUI();
      startTurnRandom();
    }).catch(() => {
      alert("Erreur chargement données.");
      window.location.href = "index.html";
    });

    // Met à jour l'affichage montures, PV, boutons
    function updateUI() {
      // Joueur 1
      const m1 = team1[currentIndex1];
      p1Img.src = m1.image;
      p1Img.alt = m1.name;
      p1Name.textContent = m1.name;
      updateHpBar(p1HpBar, p1HpText, hp1);

      // Joueur 2
      const m2 = team2[currentIndex2];
      p2Img.src = m2.image;
      p2Img.alt = m2.name;
      p2Name.textContent = m2.name;
      updateHpBar(p2HpBar, p2HpText, hp2);

      // Désactiver les boutons au début de l'update
      p1AttackBtn.disabled = true;
      p2AttackBtn.disabled = true;

      // Message
      messageDiv.textContent = `Tour du joueur ${currentTurn}`;
    }

    // Met à jour la barre de PV
    function updateHpBar(barElem, textElem, hp) {
      let width = (hp / MAX_HP) * 100;
      if (width < 0) width = 0;
      barElem.style.width = width + "%";
      textElem.textContent = `${hp} / ${MAX_HP}`;
      barElem.parentElement.setAttribute("aria-valuenow", hp);
    }

    // Détermine aléatoirement qui commence et active le bouton attaque
    function startTurnRandom() {
      currentTurn = Math.random() < 0.5 ? '1' : '2';
      messageDiv.textContent = `Le joueur ${currentTurn} commence !`;

      setTimeout(() => {
        startTurn();
      }, 1500);
    }

    // Démarre le tour du joueur courant
    function startTurn() {
      tapCount = 0;
      messageDiv.textContent = `Joueur ${currentTurn}, tapez sur "Attaquer" le plus vite possible pendant 5 secondes !`;

      if (currentTurn === '1') {
        p1AttackBtn.disabled = false;
        p2AttackBtn.disabled = true;
      } else {
        p1AttackBtn.disabled = true;
        p2AttackBtn.disabled = false;
      }

      // Écoute des clics
      // Bouton actif incremente tapCount
    }

    // Fin du tour : calcule dégâts, applique, passe au suivant
    function endTurn() {
      // Dégâts : 2 PV par 10 tapotements
      const damage = Math.floor(tapCount / 10) * 2;
      messageDiv.textContent = `Le joueur ${currentTurn} inflige ${damage} PV de dégâts !`;

      if (currentTurn === '1') {
        hp2 -= damage;
        if (hp2 < 0) hp2 = 0;
      } else {
        hp1 -= damage;
        if (hp1 < 0) hp1 = 0;
      }

      updateUI();

      // Vérifier si monture morte
      if (hp1 === 0) {
        currentIndex1++;
        if (currentIndex1 >= team1.length) {
          alert("Le joueur 2 a gagné !");
          window.location.href = "index.html";
          return;
        }
        hp1 = MAX_HP;
        messageDiv.textContent = "Monture joueur 1 suivante !";
        updateUI();
      }

      if (hp2 === 0) {
        currentIndex2++;
        if (currentIndex2 >= team2.length) {
          alert("Le joueur 1 a gagné !");
          window.location.href = "index.html";
          return;
        }
        hp2 = MAX_HP;
        messageDiv.textContent = "Monture joueur 2 suivante !";
        updateUI();
      }

      // Passage au joueur suivant
      currentTurn = currentTurn === '1' ? '2' : '1';

      setTimeout(() => {
        startTurn();
      }, 1500);
    }

    // Gestion des clics attaque
    p1AttackBtn.addEventListener("click", () => {
      if (currentTurn === '1' && !p1AttackBtn.disabled) {
        tapCount++;
      }
    });

    p2AttackBtn.addEventListener("click", () => {
      if (currentTurn === '2' && !p2AttackBtn.disabled) {
        tapCount++;
      }
    });

    // Lance la phase de tap pendant 5 secondes puis fin de tour
    function startTurn() {
      tapCount = 0;
      messageDiv.textContent = `Joueur ${currentTurn}, tapez sur "Attaquer" le plus vite possible pendant 5 secondes !`;

      if (currentTurn === '1') {
        p1AttackBtn.disabled = false;
        p2AttackBtn.disabled = true;
      } else {
        p1AttackBtn.disabled = true;
        p2AttackBtn.disabled = false;
      }

      if (attackTimer) clearTimeout(attackTimer);
      attackTimer = setTimeout(() => {
        p1AttackBtn.disabled = true;
        p2AttackBtn.disabled = true;
        endTurn();
      }, 5000);
    }
  </script>
</body>
</html>
