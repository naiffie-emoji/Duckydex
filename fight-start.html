<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Combat - Duckydex</title>
  <link rel="icon" type="image/png" href="filet-canard.png" />
  <style>
    /* [Styles identiques à ton code initial, inchangés pour clarté] */
    /* ... */
  </style>
</head>
<body>
  <div id="player1" aria-label="Joueur 1">
    <img src="" alt="Monture joueur 1" id="p1-img" />
    <div class="info">
      <div class="name" id="p1-name"></div>
      <div class="hp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
        <div class="hp-bar-inner" id="p1-hp-bar" style="width: 100%"></div>
        <div class="hp-text" id="p1-hp-text">100 / 100</div>
      </div>
    </div>
    <button class="attack-btn" id="p1-attack-btn" disabled>Attaquer</button>
  </div>

  <div id="message" role="alert" aria-live="polite"></div>

  <div id="player2" aria-label="Joueur 2">
    <button class="attack-btn" id="p2-attack-btn" disabled>Attaquer</button>
    <div class="info">
      <div class="name" id="p2-name"></div>
      <div class="hp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
        <div class="hp-bar-inner" id="p2-hp-bar" style="width: 100%"></div>
        <div class="hp-text" id="p2-hp-text">100 / 100</div>
      </div>
    </div>
    <img src="" alt="Monture joueur 2" id="p2-img" />
  </div>

  <div id="tap-area" aria-label="Zone de tapotage" role="button" tabindex="0"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const ids1 = (urlParams.get("ids1") || "").split(",").filter((id) => id.trim());
    const ids2 = (urlParams.get("ids2") || "").split(",").filter((id) => id.trim());
    const isBot = urlParams.get("bot") === "1";

    let duckData = [], team1 = [], team2 = [];
    let currentIndex1 = 0, currentIndex2 = 0;
    let maxHp1 = 0, maxHp2 = 0, hp1 = 0, hp2 = 0;
    let tapCount = 0;
    let currentTurn = null;
    let attackTimer = null, countdownTimer = null;

    const p1Img = document.getElementById("p1-img");
    const p1Name = document.getElementById("p1-name");
    const p1HpBar = document.getElementById("p1-hp-bar");
    const p1HpText = document.getElementById("p1-hp-text");
    const p1AttackBtn = document.getElementById("p1-attack-btn");

    const p2Img = document.getElementById("p2-img");
    const p2Name = document.getElementById("p2-name");
    const p2HpBar = document.getElementById("p2-hp-bar");
    const p2HpText = document.getElementById("p2-hp-text");
    const p2AttackBtn = document.getElementById("p2-attack-btn");

    const messageDiv = document.getElementById("message");
    const tapArea = document.getElementById("tap-area");

    function getHpMaxByRarity(rarity) {
      switch (rarity.toLowerCase()) {
        case "commun": return 10;
        case "rare": return 20;
        case "épique": return 30;
        case "legendaire":
        case "légendaire": return 40;
        default: return 10;
      }
    }

    fetch("canards.json")
      .then((res) => res.json())
      .then((data) => {
        duckData = data;
        team1 = ids1.map(id => duckData.find(d => d.id === id)).filter(Boolean);
        team2 = ids2.map(id => duckData.find(d => d.id === id)).filter(Boolean);

        if (team1.length === 0 || team2.length === 0) {
          alert("Erreur : équipe invalide.");
          window.location.href = "index.html";
          return;
        }

        currentIndex1 = 0;
        currentIndex2 = 0;
        maxHp1 = getHpMaxByRarity(team1[currentIndex1].rarity);
        hp1 = maxHp1;
        maxHp2 = getHpMaxByRarity(team2[currentIndex2].rarity);
        hp2 = maxHp2;

        if (isBot) {
          p2AttackBtn.style.display = "none";
        }

        updateUI();
        startTurnRandom();
      })
      .catch(() => {
        alert("Erreur chargement données.");
        window.location.href = "index.html";
      });

    function updateUI() {
      const m1 = team1[currentIndex1];
      p1Img.src = m1.image;
      p1Img.alt = m1.name;
      p1Name.textContent = m1.name;
      updateHpBar(p1HpBar, p1HpText, hp1, maxHp1);

      const m2 = team2[currentIndex2];
      p2Img.src = m2.image;
      p2Img.alt = m2.name;
      p2Name.textContent = m2.name;
      updateHpBar(p2HpBar, p2HpText, hp2, maxHp2);

      p1AttackBtn.disabled = true;
      p2AttackBtn.disabled = true;

      if (!messageDiv.textContent.startsWith("Le joueur")) {
        messageDiv.textContent = `Tour du joueur ${currentTurn}`;
      }
    }

    function updateHpBar(barElem, textElem, hp, maxHp) {
      let width = (hp / maxHp) * 100;
      barElem.style.width = width + "%";
      textElem.textContent = `${hp} / ${maxHp}`;
      barElem.parentElement.setAttribute("aria-valuenow", hp);
      barElem.parentElement.setAttribute("aria-valuemax", maxHp);
    }

    function startTurnRandom() {
      currentTurn = Math.random() < 0.5 ? "1" : "2";
      messageDiv.textContent = `Le joueur ${currentTurn} commence !`;
      setTimeout(() => enableAttackBtn(), 1500);
    }

    function enableAttackBtn() {
      if (currentTurn === "1") {
        p1AttackBtn.disabled = false;
      } else if (!isBot) {
        p2AttackBtn.disabled = false;
      } else {
        setTimeout(botAttack, 1500); // Bot joue automatiquement après un délai
      }
      messageDiv.textContent = `Tour du joueur ${currentTurn}`;
    }

    function onAttackBtnClick() {
      p1AttackBtn.disabled = true;
      p2AttackBtn.disabled = true;
      let countdown = 3;
      tapCount = 0;
      tapArea.style.display = "flex";
      tapArea.textContent = `Joueur ${currentTurn}, préparez-vous... ${countdown}`;

      countdownTimer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          tapArea.textContent = `Joueur ${currentTurn}, préparez-vous... ${countdown}`;
        } else {
          clearInterval(countdownTimer);
          startTappingPhase();
        }
      }, 1000);
    }

    function startTappingPhase() {
      let timeLeft = 5;
      tapArea.textContent = `Joueur ${currentTurn}, tapotez ici !\nTemps restant : ${timeLeft}s`;
      function tapHandler() {
        tapCount++;
      }
      tapArea.addEventListener("click", tapHandler);

      attackTimer = setInterval(() => {
        timeLeft--;
        if (timeLeft > 0) {
          tapArea.textContent = `Joueur ${currentTurn}, tapotez ici !\nTemps restant : ${timeLeft}s`;
        } else {
          clearInterval(attackTimer);
          tapArea.removeEventListener("click", tapHandler);
          tapArea.style.display = "none";
          const damage = Math.floor(tapCount / 5);
          applyDamage(damage);
        }
      }, 1000);
    }

    function botAttack() {
      messageDiv.textContent = `Le bot prépare son attaque...`;
      tapCount = Math.floor(Math.random() * (100 - 25 + 1)) + 25;
      setTimeout(() => {
        const damage = Math.floor(tapCount / 5);
        applyDamage(damage);
      }, 1000);
    }

    function applyDamage(damage) {
      if (damage === 0) {
        messageDiv.textContent = `Pas assez de tapotements pour infliger des dégâts.`;
      } else {
        messageDiv.textContent = `Joueur ${currentTurn} inflige ${damage} point(s) de dégâts !`;
      }

      if (currentTurn === "1") {
        hp2 -= damage;
        if (hp2 < 0) hp2 = 0;
      } else {
        hp1 -= damage;
        if (hp1 < 0) hp1 = 0;
      }

      updateUI();

      if (currentTurn === "1" && hp2 <= 0) {
        currentIndex2++;
        if (currentIndex2 >= team2.length) {
          endGame(1);
          return;
        } else {
          maxHp2 = getHpMaxByRarity(team2[currentIndex2].rarity);
          hp2 = maxHp2;
          messageDiv.textContent = "Joueur 2 change de monture !";
          updateUI();
        }
      } else if (currentTurn === "2" && hp1 <= 0) {
        currentIndex1++;
        if (currentIndex1 >= team1.length) {
          endGame(2);
          return;
        } else {
          maxHp1 = getHpMaxByRarity(team1[currentIndex1].rarity);
          hp1 = maxHp1;
          messageDiv.textContent = "Joueur 1 change de monture !";
          updateUI();
        }
      }

      currentTurn = currentTurn === "1" ? "2" : "1";
      setTimeout(() => {
        messageDiv.textContent = `Tour du joueur ${currentTurn}`;
        enableAttackBtn();
      }, 2000);
    }

    function endGame(winner) {
      p1AttackBtn.disabled = true;
      p2AttackBtn.disabled = true;
      tapArea.style.display = "none";
      messageDiv.textContent = `Le joueur ${winner} a gagné le combat ! Redirection...`;
      setTimeout(() => {
        window.location.href = "index.html";
      }, 3000);
    }

    p1AttackBtn.addEventListener("click", () => {
      if (currentTurn === "1") onAttackBtnClick();
    });

    p2AttackBtn.addEventListener("click", () => {
      if (!isBot && currentTurn === "2") onAttackBtnClick();
    });
  </script>
</body>
</html>
