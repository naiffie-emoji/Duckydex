<!DOCTYPE html>      
<html lang="fr">      
<head>      
  <meta charset="UTF-8" />      
  <meta name="viewport" content="width=device-width, initial-scale=1" />      
  <title>Z≈çion</title>      
  <link rel="icon" type="image/png" href="filet-canard.png" />      
  <style>      
    body {      
      margin: 0;      
      font-family: sans-serif;      
      background: #f0f8ff;      
      color: #333;      
    }      
      
    header {      
      background-color: #4dabf7;      
      color: white;      
      padding: 1rem;      
      display: flex;      
      justify-content: space-between;      
      align-items: center;      
    }      
      
    .burger {      
      display: none;      
      flex-direction: column;      
      gap: 4px;      
      cursor: pointer;      
    }      
      
    .burger span {      
      width: 25px;      
      height: 3px;      
      background: white;      
    }      
      
    nav {      
      display: flex;      
      gap: 1rem;      
    }      
      
    nav a {      
      color: white;      
      text-decoration: none;      
      font-weight: bold;      
    }      
      
    main {      
      padding: 2rem;      
      display: flex;      
      flex-direction: column;      
      align-items: center;      
    }      
      
    .card {      
      background: white;      
      border-radius: 12px;      
      padding: 2rem;      
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);      
      text-align: center;      
      max-width: 300px;      
    }      

    .xp-bar-container {
      background: #ddd;
      border-radius: 10px;
      width: 100%;
      height: 20px;
      margin: 1rem 0;
      overflow: hidden;
    }
    .xp-bar {
      height: 100%;
      background: #38d9a9;
      width: 0%;
      transition: width 0.5s ease;
    }

    select, button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }

    .back-btn {      
      margin-top: 2rem;      
      padding: 0.5rem 1rem;      
      background-color: #4dabf7;      
      color: white;      
      border: none;      
      border-radius: 8px;      
      text-decoration: none;      
      font-size: 1rem;      
    }      
      
    @media (max-width: 600px) {      
      nav {      
        display: none;      
        flex-direction: column;      
        background-color: #4dabf7;      
        padding: 1rem;      
      }      
      
      nav.active {      
        display: flex;      
      }      
      
      .burger {      
        display: flex;      
      }      
    }      
  </style>      
</head>      
<body>      
  <header>      
    <h1>Z≈çion</h1>      
    <div class="burger" onclick="toggleMenu()">      
      <span></span><span></span><span></span>      
    </div>      
    <nav id="menu">      
      <a href="index.html">üéÅ Obtenir un Z≈çion</a>      
      <a href="collection.html">üéü Ma collection</a>      
    </nav>      
  </header>      
      
  <main>      
    <div id="zoionCard" class="card">      
      <p>Chargement...</p>      
    </div>      
    <a href="collection.html" class="back-btn">‚¨Ö Retour</a>      
  </main>      

  <script>      
    function toggleMenu() {      
      document.getElementById("menu").classList.toggle("active");      
    }      

    const params = new URLSearchParams(window.location.search);      
    const id = params.get("id");      
    const card = document.getElementById("zoionCard");      

    const XP_MAX = 100;

    // Fonction pour charger les niveaux/XP depuis localStorage (objet { id: {level, xp} })
    function loadLevels() {
      return JSON.parse(localStorage.getItem("zoionLevels") || "{}");
    }

    // Fonction pour sauver niveaux/XP
    function saveLevels(levels) {
      localStorage.setItem("zoionLevels", JSON.stringify(levels));
    }

    // Calcul de l'XP gagn√©e en nourrissant, selon raret√© et niveau du zoion donn√©
    function xpGain(rarity, donorLevel) {
      // Pond√©ration par raret√© (valeurs arbitraires)
      const rarityValue = {
        "Commun": 10,
        "Rare": 20,
        "√âpique": 40,
        "L√©gendaire": 80
      };
      return (rarityValue[rarity] || 10) + donorLevel * 5;
    }

    if (!id) {      
      card.innerHTML = "<p>Erreur : aucun identifiant fourni.</p>";      
    } else {      
      fetch("canards.json")      
        .then(res => res.json())      
        .then(data => {      
          const duck = data.find(d => d.id === id);      
          if (!duck) {      
            card.innerHTML = "<p>Z≈çion introuvable.</p>";      
            return;
          }

          // Charge niveaux/XP
          let levels = loadLevels();
          if (!levels[id]) {
            levels[id] = { level: 1, xp: 0 };
            saveLevels(levels);
          }

          function updateDisplay() {
            const lvl = levels[id].level;
            const xp = levels[id].xp;
            const xpPercent = Math.min(100, (xp / XP_MAX) * 100);

            card.innerHTML = `
              <img src="${duck.image}" alt="${duck.name}" style="max-width: 150px; max-height: 150px; margin-bottom: 1rem;">
              <h2>${duck.name}</h2>
              <p>Raret√© : ${duck.rarity}</p>
              <p>Niveau : ${lvl}</p>
              <div class="xp-bar-container" title="XP: ${xp} / ${XP_MAX}">
                <div class="xp-bar" style="width: ${xpPercent}%;"></div>
              </div>
              <label for="donorSelect">Nourrir avec un autre Z≈çion :</label><br>
              <select id="donorSelect">
                <option value="">-- Choisir un Zoion --</option>
              </select><br>
              <button id="feedBtn" disabled>Nourrir</button>
            `;
            // Remplir le select avec la collection sauf le zoion affich√©
            const donorSelect = document.getElementById("donorSelect");
            const feedBtn = document.getElementById("feedBtn");

            const collection = JSON.parse(localStorage.getItem("collection") || "[]");
            const donors = collection.filter(did => did !== id);

            donors.forEach(did => {
              const donorDuck = data.find(d => d.id === did);
              if (donorDuck) {
                // R√©cup√©rer niveau du donneur
                const donorLevel = (levels[did]?.level) || 1;
                donorSelect.innerHTML += `<option value="${did}">${donorDuck.name} (Lvl ${donorLevel})</option>`;
              }
            });

            donorSelect.addEventListener("change", () => {
              feedBtn.disabled = donorSelect.value === "";
            });

            feedBtn.addEventListener("click", () => {
              const donorId = donorSelect.value;
              if (!donorId) return;

              feedBtn.disabled = true; // d√©sactiver pour √©viter multi-clic

              const donorDuck = data.find(d => d.id === donorId);
              if (!donorDuck) return;

              const donorLevel = (levels[donorId]?.level) || 1;
              // Calcul XP gagn√©e
              const gainedXP = xpGain(donorDuck.rarity, donorLevel);

              // Mise √† jour XP du zoion courant
              levels[id].xp += gainedXP;

              // Gestion niveau up
              while (levels[id].xp >= XP_MAX) {
                levels[id].xp -= XP_MAX;
                levels[id].level++;
                alert(`${duck.name} a mont√© un niveau ! Niveau actuel : ${levels[id].level}`);
              }

              // Sauvegarder niveaux/XP
              saveLevels(levels);

              // Supprimer le zoion donneur de la collection
              const collection = JSON.parse(localStorage.getItem("collection") || "[]");
              const newCollection = collection.filter(d => d !== donorId);
              localStorage.setItem("collection", JSON.stringify(newCollection));

              // Mise √† jour affichage
              updateDisplay();
            });
          }

          updateDisplay();

        })      
        .catch(err => {      
          console.error(err);      
          card.innerHTML = "<p>Erreur lors du chargement des donn√©es.</p>";      
        });      
    }      
  </script>      
</body>      
</html>
